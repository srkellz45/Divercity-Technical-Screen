{"ast":null,"code":"import _toConsumableArray from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _classCallCheck from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _assertThisInitialized from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";\nvar _jsxFileName = \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/src/containers/Messages/ChatBox/index.js\";\nimport React, { Component } from 'react';\nimport { connect } from 'react-redux';\nimport { getUser } from '../../../actions/user.actions';\nimport { sendNewMessage, loadChat, createChatID, getAllChats } from '../../../actions/chat.actions';\nimport { url } from '../../../lib/url';\nimport Message from '../../../components/message.message.components.js';\nvar wssURL = 'wss://api.divercity.io/cable';\nvar socketURL = \"\".concat(wssURL, \"/?token=\").concat(localStorage.getItem('access-token'), \"&client=\").concat(localStorage.getItem('client'), \"&uid=\").concat(localStorage.getItem('uid'));\nvar ws = new WebSocket(socketURL);\n\nvar ChatBox =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(ChatBox, _Component);\n\n  function ChatBox(props) {\n    var _this;\n\n    _classCallCheck(this, ChatBox);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(ChatBox).call(this, props));\n\n    _this.addMessage = function (message) {\n      // Append the message to the component state\n      var messageAdd = _this.state.chatHistory;\n      messageAdd.push(message);\n\n      _this.setState({\n        chatHistory: messageAdd\n      }); //ws.send(JSON.stringify(messages));\n\n    };\n\n    _this.openSocket = function () {\n      var socketURL = \"\".concat(wssURL, \"/?token=\").concat(localStorage.getItem('access-token'), \"&client=\").concat(localStorage.getItem('client'), \"&uid=\").concat(localStorage.getItem('uid'));\n      var ws = new WebSocket(socketURL);\n      var subscribe_params = JSON.stringify({\n        command: 'subscribe',\n        identifier: JSON.stringify({\n          chat_id: _this.props.canon,\n          channel: 'MessagesChannel'\n        })\n      });\n\n      ws.onopen = function (e) {\n        console.log(e, 'onopen ------'); // SUBSCRIBE\n\n        ws.send(subscribe_params);\n      };\n\n      ws.onmessage = function (evt) {\n        var receivedData = JSON.parse(evt.data || '{}');\n        var dataIdentity = JSON.parse(receivedData.identifier || '{}');\n        var messageData = receivedData.message;\n\n        if (receivedData.identifier && dataIdentity.channel === 'MessagesChannel' && dataIdentity.chat_id === this.state.chatID && messageData) {\n          var incomingMessage = receivedData.message;\n\n          if (incomingMessage.from_username && incomingMessage.from_username !== localStorage.username) {\n            this.handleMessage(incomingMessage);\n          }\n\n          if (incomingMessage.event_type && incomingMessage.event_type.match(/rtm/)) {\n            if (parseInt(this.state.otherID) === parseInt(incomingMessage.typing_user_id)) {\n              if (incomingMessage.event_sub_type === 'start_chat_typing') {\n                this.setState({\n                  userTyping: true,\n                  userNameTyping: incomingMessage.message\n                });\n              }\n\n              if (incomingMessage.event_sub_type === 'end_chat_typing') {\n                this.setState({\n                  userTyping: false,\n                  userNameTyping: ''\n                });\n              }\n            }\n          }\n        }\n      }.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n\n      ws.onclose = function (e) {\n        console.log(e, \"Connection is closed...\");\n      };\n    };\n\n    _this.handleMessage = function (msg) {\n      if (_this.state.userTyping) {\n        _this.setState({\n          chatHistory: [].concat(_toConsumableArray(_this.state.chatHistory), [msg]),\n          userTyping: false,\n          userNameTyping: ''\n        });\n      }\n    };\n\n    _this.clearHistory = function () {\n      return _this.setState({\n        chatHistory: []\n      });\n    };\n\n    _this.sendHandler = function (evt) {\n      evt.preventDefault();\n      var messageObject = {\n        from_username: localStorage.username,\n        message: _this.state.chatInput,\n        from_user_avatar_thumb: localStorage.image\n      }; //console.log(this.state.chatID, \"CHATID\");\n      // Emit the message to the server\n\n      _this.props.sendNewMessage(messageObject.message, _this.state.chatID);\n\n      messageObject.fromMe = true;\n\n      _this.addMessage(messageObject);\n\n      _this.setState({\n        chatInput: ''\n      });\n    };\n\n    _this.handleChatInput = function (evt) {\n      return _this.setState({\n        chatInput: evt.target.value\n      });\n    };\n\n    _this.state = {\n      chatHistory: [],\n      searchValue: '',\n      chatInput: '',\n      chatID: props.canon,\n      otherID: '',\n      userTyping: false,\n      userNameTyping: '',\n      ID: parseInt(localStorage.getItem('id'))\n    };\n    return _this;\n  }\n\n  _createClass(ChatBox, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var ID = this.state.ID;\n      this.openSocket();\n      this.props.getUser(ID);\n      this.props.getAllChats(ID); //this.props.createChatID(ID, this.props.match.params.id);\n      // This loads the most recent messages upon receiving allMessages PROPS\n\n      if (!this.state.chatID.length) {\n        this.setState({\n          chatID: this.props.allMessages[0].chat_id,\n          otherID: this.props.allMessages[0].id\n        });\n        this.props.loadChat(ID, this.props.allMessages[0].chat_id, this.props.allMessages[0].id);\n      }\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      ws.close();\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps, prevState) {\n      // This loads the most recent messages upon receiving allMessages PROPS\n      if (prevProps.messages !== this.props.messages) {\n        this.clearHistory();\n        this.openSocket();\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(React.Fragment, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 164\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"Messages-ChatInput\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 165\n        },\n        __self: this\n      }, React.createElement(\"form\", {\n        className: \"chat-input\",\n        onSubmit: this.sendHandler,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 166\n        },\n        __self: this\n      }, React.createElement(\"input\", {\n        type: \"text\",\n        onChange: this.handleChatInput,\n        value: this.state.chatInput,\n        placeholder: \"Write a Message...\",\n        autoFocus: true,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 167\n        },\n        __self: this\n      }))), this.state.userTyping ? React.createElement(\"div\", {\n        className: \"User-Typing\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 177\n        },\n        __self: this\n      }, this.state.userNameTyping) : null, React.createElement(\"div\", {\n        className: \"myMessages\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 182\n        },\n        __self: this\n      }, this.state.chatHistory.length ? React.createElement(React.Fragment, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 184\n        },\n        __self: this\n      }, this.state.chatHistory.map(function (chats, i) {\n        return React.createElement(\"div\", {\n          className: \"DirectMessages\",\n          key: i,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 186\n          },\n          __self: this\n        }, React.createElement(Message, {\n          messages: chats,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 187\n          },\n          __self: this\n        }));\n      })) : null), this.props.messages.map(function (oldMessages, i) {\n        return React.createElement(\"div\", {\n          className: \"DirectMessages\",\n          key: i,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 195\n          },\n          __self: this\n        }, React.createElement(Message, {\n          messages: oldMessages,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 196\n          },\n          __self: this\n        }));\n      }));\n    }\n  }]);\n\n  return ChatBox;\n}(Component);\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    user: state.userList,\n    chatID: state.chatID,\n    messages: state.chatList,\n    allMessages: state.allChatsList\n  };\n};\n\nexport default connect(mapStateToProps, {\n  getUser: getUser,\n  sendNewMessage: sendNewMessage,\n  loadChat: loadChat,\n  createChatID: createChatID,\n  getAllChats: getAllChats\n})(ChatBox);","map":{"version":3,"sources":["/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/src/containers/Messages/ChatBox/index.js"],"names":["React","Component","connect","getUser","sendNewMessage","loadChat","createChatID","getAllChats","url","Message","wssURL","socketURL","localStorage","getItem","ws","WebSocket","ChatBox","props","addMessage","message","messageAdd","state","chatHistory","push","setState","openSocket","subscribe_params","JSON","stringify","command","identifier","chat_id","canon","channel","onopen","e","console","log","send","onmessage","evt","receivedData","parse","data","dataIdentity","messageData","chatID","incomingMessage","from_username","username","handleMessage","event_type","match","parseInt","otherID","typing_user_id","event_sub_type","userTyping","userNameTyping","bind","onclose","msg","clearHistory","sendHandler","preventDefault","messageObject","chatInput","from_user_avatar_thumb","image","fromMe","handleChatInput","target","value","searchValue","ID","length","allMessages","id","close","prevProps","prevState","messages","map","chats","i","oldMessages","mapStateToProps","user","userList","chatList","allChatsList"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport { connect } from 'react-redux';\nimport { getUser } from '../../../actions/user.actions';\nimport { sendNewMessage, loadChat, createChatID, getAllChats } from '../../../actions/chat.actions';\nimport { url } from '../../../lib/url';\nimport Message from '../../../components/message.message.components.js';\n\nlet wssURL = 'wss://api.divercity.io/cable';\nlet socketURL = `${wssURL}/?token=${localStorage.getItem('access-token')}&client=${localStorage.getItem('client')}&uid=${localStorage.getItem('uid')}`;\nlet ws = new WebSocket(socketURL);\n\nclass ChatBox extends Component {\n\tconstructor(props) {\n\t\tsuper(props);\n\n\t\tthis.state = {\n\t\t\tchatHistory: [],\n\t\t\tsearchValue: '',\n\t\t\tchatInput: '',\n\t\t\tchatID: props.canon,\n\t\t\totherID: '',\n\t\t\tuserTyping: false,\n\t\t\tuserNameTyping: '',\n\t\t\tID: parseInt(localStorage.getItem('id'))\n\t\t};\n\t}\n\n\taddMessage = message => {\n\t\t// Append the message to the component state\n\t\tlet messageAdd = this.state.chatHistory;\n\t\tmessageAdd.push(message);\n\n\t\tthis.setState({\n\t\t\tchatHistory: messageAdd\n\t\t});\n\t\t//ws.send(JSON.stringify(messages));\n\t}\n\n  componentDidMount() {\n    var {ID} = this.state;\n\n    this.openSocket();\n    this.props.getUser(ID);\n    this.props.getAllChats(ID);\n    //this.props.createChatID(ID, this.props.match.params.id);\n    // This loads the most recent messages upon receiving allMessages PROPS\n    if(!this.state.chatID.length){\n      this.setState({\n        chatID: this.props.allMessages[0].chat_id,\n        otherID: this.props.allMessages[0].id,\n      });\n      this.props.loadChat(ID, this.props.allMessages[0].chat_id, this.props.allMessages[0].id);\n    }\n  }\n\n  openSocket = () => {\n    let socketURL = `${wssURL}/?token=${localStorage.getItem('access-token')}&client=${localStorage.getItem('client')}&uid=${localStorage.getItem('uid')}`;\n    let ws = new WebSocket(socketURL);\n\n    let subscribe_params = JSON.stringify({\n      command: 'subscribe',\n      identifier: JSON.stringify({\n        chat_id: this.props.canon,\n        channel: 'MessagesChannel'\n      })\n    });\n\n    ws.onopen = function(e) {\n      console.log(e, 'onopen ------');\n      // SUBSCRIBE\n      ws.send(subscribe_params);\n    };\n\n    ws.onmessage = function (evt) {\n      var receivedData = JSON.parse(evt.data || '{}');\n      var dataIdentity = JSON.parse(receivedData.identifier || '{}');\n      var messageData = receivedData.message;\n      if (\n        receivedData.identifier &&\n        dataIdentity.channel === 'MessagesChannel' &&\n        dataIdentity.chat_id === this.state.chatID &&\n        messageData\n      ) {\n        var incomingMessage = receivedData.message;\n        if (incomingMessage.from_username && incomingMessage.from_username !== localStorage.username) {\n          this.handleMessage(incomingMessage);\n        }\n        if (incomingMessage.event_type && incomingMessage.event_type.match(/rtm/)) {\n          if (parseInt(this.state.otherID) === parseInt(incomingMessage.typing_user_id)) {\n\n            if (incomingMessage.event_sub_type === 'start_chat_typing') {\n              this.setState({\n                userTyping: true,\n                userNameTyping: incomingMessage.message\n              });\n            }\n            if (incomingMessage.event_sub_type === 'end_chat_typing') {\n              this.setState({\n                userTyping: false,\n                userNameTyping: ''\n              });\n            }\n          }\n        }\n\n      }\n    }.bind(this);\n\n    ws.onclose = function(e) {\n      console.log(e, \"Connection is closed...\");\n    };\n  }\n  componentWillUnmount() {\n    ws.close();\n  }\n  handleMessage = msg => {\n    if( this.state.userTyping ) {\n      this.setState({\n        chatHistory : [ ...this.state.chatHistory, msg ],\n        userTyping : false,\n        userNameTyping : ''\n      });\n    }\n  }\n\n\n\tclearHistory =  () => this.setState({\n\t\tchatHistory: []\n\t});\n\n  componentDidUpdate(prevProps, prevState) {\n    // This loads the most recent messages upon receiving allMessages PROPS\n    if (prevProps.messages !== this.props.messages) {\n      this.clearHistory();\n      this.openSocket();\n    }\n  }\n\n  sendHandler = evt => {\n    evt.preventDefault();\n    const messageObject = {\n      from_username: localStorage.username,\n      message: this.state.chatInput,\n      from_user_avatar_thumb: localStorage.image\n    };\n    //console.log(this.state.chatID, \"CHATID\");\n    // Emit the message to the server\n    this.props.sendNewMessage(messageObject.message, this.state.chatID);\n\n    messageObject.fromMe = true;\n\n    this.addMessage(messageObject);\n    this.setState({\n      chatInput: ''\n    });\n  }\n\n\thandleChatInput = evt => this.setState({\n\t\tchatInput: evt.target.value\n\t});\n\n  render() {\n    return (\n        <React.Fragment>\n          <div className=\"Messages-ChatInput\">\n            <form className=\"chat-input\" onSubmit={this.sendHandler}>\n              <input type=\"text\"\n                onChange={this.handleChatInput}\n                value={this.state.chatInput}\n                placeholder=\"Write a Message...\"\n                autoFocus={true}\n                />\n            </form>\n          </div>\n\n          { this.state.userTyping ? (\n              <div className=\"User-Typing\">\n                { this.state.userNameTyping }\n              </div>\n          ) : null }\n\n          <div className=\"myMessages\">\n          { this.state.chatHistory.length ? (\n            <React.Fragment>\n              { this.state.chatHistory.map((chats, i) => (\n                  <div className=\"DirectMessages\" key={i}>\n                    <Message messages={ chats } />\n                  </div>\n                ))}\n            </React.Fragment>\n          ) : null }\n          </div>\n\n\t\t\t{ this.props.messages.map((oldMessages, i) => (\n\t\t\t\t\t<div className=\"DirectMessages\" key={i}>\n\t\t\t\t\t\t<Message messages={ oldMessages } />\n\t\t\t\t\t</div>\n\t\t\t\t))\n\t\t\t}\n        </React.Fragment>\n    );\n  }\n}\n\nconst mapStateToProps = state => ({\n\tuser : state.userList,\n\tchatID : state.chatID,\n\tmessages : state.chatList,\n\tallMessages : state.allChatsList\n});\n\nexport default connect(mapStateToProps, {getUser, sendNewMessage, loadChat, createChatID, getAllChats})(ChatBox);"]},"metadata":{},"sourceType":"module"}