{"ast":null,"code":"import _toConsumableArray from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _classCallCheck from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _assertThisInitialized from \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";\nvar _jsxFileName = \"/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/src/containers/NewMessages/NewMessageChatBox/index.js\";\nimport React, { Component } from 'react';\nimport { connect } from 'react-redux';\nimport { getUser as _getUser } from '../../../actions/user.actions';\nimport { sendFirstMessage as _sendFirstMessage, loadChat as _loadChat, createChatID as _createChatID, getAllChats as _getAllChats } from '../../../actions/chat.actions';\nimport { url } from '../../../lib/url';\nimport Message from '../../../components/message.message.components.js';\nvar wssURL = 'wss://api.divercity.io/cable';\nvar ID = parseInt(localStorage.getItem('id'));\nvar socketURL = \"\".concat(wssURL, \"/?token=\").concat(localStorage.getItem('access-token'), \"&client=\").concat(localStorage.getItem('client'), \"&uid=\").concat(localStorage.getItem('uid'));\nvar ws = new WebSocket(socketURL);\n\nvar NewMessageChatBox =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(NewMessageChatBox, _Component);\n\n  function NewMessageChatBox(props) {\n    var _this;\n\n    _classCallCheck(this, NewMessageChatBox);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(NewMessageChatBox).call(this, props));\n    _this.state = {\n      chatHistory: [],\n      searchValue: '',\n      chatInput: '',\n      chatID: '',\n      otherID: '',\n      userTyping: false,\n      userNameTyping: ''\n    };\n    _this.sendHandler = _this.sendHandler.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    _this.addMessage = _this.addMessage.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    _this.handleChatInput = _this.handleChatInput.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    _this.openSocket = _this.openSocket.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    _this.clearHistory = _this.clearHistory.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    return _this;\n  }\n\n  _createClass(NewMessageChatBox, [{\n    key: \"addMessage\",\n    value: function addMessage(message) {\n      // Append the message to the component state\n      var messageAdd = this.state.chatHistory;\n      messageAdd.push(message);\n      this.setState({\n        chatHistory: messageAdd\n      }); //ws.send(JSON.stringify(messages));\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.openSocket();\n      this.props.getUser(ID);\n      this.props.getAllChats(ID); //this.props.createChatID(ID, this.props.match.params.id);\n      // This loads the most recent messages upon receiving allMessages PROPS\n      // if(!localStorage.chatID.length){\n      //   this.setState({\n      //     chatID: this.props.allMessages[0].chat_id,\n      //     otherID: this.props.allMessages[0].id,\n      //   });\n      //   this.props.loadChat(ID, this.props.allMessages[0].chat_id, this.props.allMessages[0].id);\n      // }\n    }\n  }, {\n    key: \"openSocket\",\n    value: function openSocket() {\n      var socketURL = \"\".concat(wssURL, \"/?token=\").concat(localStorage.getItem('access-token'), \"&client=\").concat(localStorage.getItem('client'), \"&uid=\").concat(localStorage.getItem('uid'));\n      var ws = new WebSocket(socketURL);\n      var subscribe_params = JSON.stringify({\n        command: 'subscribe',\n        identifier: JSON.stringify({\n          chat_id: this.props.canon,\n          channel: 'MessagesChannel'\n        })\n      });\n\n      ws.onopen = function (e) {\n        console.log(e, 'onopen ------'); // SUBSCRIBE\n\n        ws.send(subscribe_params);\n      };\n\n      ws.onmessage = function (evt) {\n        var receivedData = JSON.parse(evt.data || '{}');\n        var dataIdentity = JSON.parse(receivedData.identifier || '{}');\n        var messageData = receivedData.message;\n\n        if (receivedData.identifier && dataIdentity.channel === 'MessagesChannel' && dataIdentity.chat_id === this.state.chatID && messageData) {\n          var incomingMessage = receivedData.message;\n\n          if (incomingMessage.event_type && incomingMessage.event_type.match(/rtm/)) {\n            if (parseInt(this.state.otherID) === parseInt(incomingMessage.typing_user_id)) {\n              if (incomingMessage.event_sub_type === 'start_chat_typing') {\n                this.setState({\n                  userTyping: true,\n                  userNameTyping: incomingMessage.message\n                });\n              }\n\n              if (incomingMessage.event_sub_type === 'end_chat_typing') {\n                this.setState({\n                  userTyping: false,\n                  userNameTyping: ''\n                });\n              }\n            }\n          }\n\n          if (incomingMessage.from_username && incomingMessage.from_username !== localStorage.username) {\n            this.setState({\n              chatHistory: [].concat(_toConsumableArray(this.state.chatHistory), [incomingMessage]),\n              userTyping: false,\n              userNameTyping: ''\n            });\n          }\n        }\n      }.bind(this);\n\n      ws.onclose = function (e) {\n        console.log(e, \"Connection is closed...\");\n      };\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      ws.close();\n      localStorage.removeItem(\"chatID\");\n    }\n  }, {\n    key: \"clearHistory\",\n    value: function clearHistory() {\n      this.setState({\n        chatHistory: []\n      });\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps, prevState) {\n      // This loads the most recent messages upon receiving allMessages PROPS\n      if (prevProps.messages !== this.props.messages) {\n        this.clearHistory();\n        this.openSocket();\n      }\n    }\n  }, {\n    key: \"sendHandler\",\n    value: function sendHandler(evt) {\n      evt.preventDefault();\n      var messageObject = {\n        from_username: localStorage.name,\n        message: this.state.chatInput,\n        from_user_avatar_thumb: localStorage.image\n      };\n      console.log(localStorage.chatID);\n      this.props.sendFirstMessage(messageObject.message, localStorage.chatID);\n      messageObject.fromMe = true;\n      this.addMessage(messageObject);\n      this.setState({\n        chatInput: ''\n      });\n    }\n  }, {\n    key: \"handleChatInput\",\n    value: function handleChatInput(evt) {\n      this.setState({\n        chatInput: evt.target.value\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(React.Fragment, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 159\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"Messages-ChatInput\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 160\n        },\n        __self: this\n      }, React.createElement(\"form\", {\n        className: \"chat-input\",\n        onSubmit: this.sendHandler,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 161\n        },\n        __self: this\n      }, React.createElement(\"input\", {\n        type: \"text\",\n        onChange: this.handleChatInput,\n        value: this.state.chatInput,\n        placeholder: \"Write a Message...\",\n        autoFocus: true,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 162\n        },\n        __self: this\n      }))), React.createElement(\"div\", {\n        className: \"myMessages\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 170\n        },\n        __self: this\n      }, this.state.chatHistory.length ? React.createElement(React.Fragment, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 172\n        },\n        __self: this\n      }, this.state.chatHistory.map(function (chats) {\n        return React.createElement(\"div\", {\n          className: \"DirectMessages\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 175\n          },\n          __self: this\n        }, React.createElement(Message, {\n          messages: chats,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 176\n          },\n          __self: this\n        }));\n      })) : null), React.createElement(\"div\", {\n        className: \"NewMessageHeader\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 184\n        },\n        __self: this\n      }, \"Send your first message\"));\n    }\n  }]);\n\n  return NewMessageChatBox;\n}(Component);\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    user: state.userList,\n    chatID: state.chatID,\n    messages: state.chatList,\n    allMessages: state.allChatsList\n  };\n};\n\nvar mapDispatchToProps = function mapDispatchToProps(dispatch) {\n  return {\n    getUser: function getUser(ID) {\n      dispatch(_getUser(ID));\n    },\n    sendFirstMessage: function sendFirstMessage(message, id) {\n      dispatch(_sendFirstMessage(message, id));\n    },\n    loadChat: function loadChat(myID, chatID, otherID) {\n      dispatch(_loadChat(myID, chatID, otherID));\n    },\n    createChatID: function createChatID(myID, otherID) {\n      dispatch(_createChatID(myID, otherID));\n    },\n    getAllChats: function getAllChats(id) {\n      dispatch(_getAllChats(id));\n    }\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(NewMessageChatBox); // <div>\n// { this.state.chatHistory.length ? (\n//     <React.Fragment>\n//         { this.state.chatHistory.map((chats) => {\n//           return (\n//             <div>\n//               <Message messages={chats} />\n//           </div>\n//           )\n//         })}\n//     </React.Fragment>\n//   ) : null }\n// </div>\n// </div>","map":{"version":3,"sources":["/Users/seanromero/Documents/web-projects/personal-projects/divercity-coding-challenge/divercity/src/containers/NewMessages/NewMessageChatBox/index.js"],"names":["React","Component","connect","getUser","sendFirstMessage","loadChat","createChatID","getAllChats","url","Message","wssURL","ID","parseInt","localStorage","getItem","socketURL","ws","WebSocket","NewMessageChatBox","props","state","chatHistory","searchValue","chatInput","chatID","otherID","userTyping","userNameTyping","sendHandler","bind","addMessage","handleChatInput","openSocket","clearHistory","message","messageAdd","push","setState","subscribe_params","JSON","stringify","command","identifier","chat_id","canon","channel","onopen","e","console","log","send","onmessage","evt","receivedData","parse","data","dataIdentity","messageData","incomingMessage","event_type","match","typing_user_id","event_sub_type","from_username","username","onclose","close","removeItem","prevProps","prevState","messages","preventDefault","messageObject","name","from_user_avatar_thumb","image","fromMe","target","value","length","map","chats","mapStateToProps","user","userList","chatList","allMessages","allChatsList","mapDispatchToProps","dispatch","id","myID"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport { connect } from 'react-redux';\nimport { getUser } from '../../../actions/user.actions';\nimport { sendFirstMessage, loadChat, createChatID, getAllChats } from '../../../actions/chat.actions';\nimport { url } from '../../../lib/url';\nimport Message from '../../../components/message.message.components.js';\n\nlet wssURL = 'wss://api.divercity.io/cable';\nlet ID = parseInt(localStorage.getItem('id'));\nlet socketURL = `${wssURL}/?token=${localStorage.getItem('access-token')}&client=${localStorage.getItem('client')}&uid=${localStorage.getItem('uid')}`;\nlet ws = new WebSocket(socketURL);\n\nclass NewMessageChatBox extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      chatHistory: [],\n      searchValue: '',\n      chatInput: '',\n      chatID: '',\n      otherID: '',\n      userTyping: false,\n      userNameTyping: '',\n    };\n    this.sendHandler = this.sendHandler.bind(this);\n    this.addMessage = this.addMessage.bind(this);\n    this.handleChatInput = this.handleChatInput.bind(this);\n    this.openSocket = this.openSocket.bind(this);\n    this.clearHistory = this.clearHistory.bind(this);\n  }\n  addMessage(message) {\n    // Append the message to the component state\n    let messageAdd = this.state.chatHistory;\n    messageAdd.push(message);\n    this.setState({\n      chatHistory: messageAdd\n    });\n    //ws.send(JSON.stringify(messages));\n  }\n  componentDidMount() {\n    this.openSocket();\n    this.props.getUser(ID);\n    this.props.getAllChats(ID);\n    //this.props.createChatID(ID, this.props.match.params.id);\n    // This loads the most recent messages upon receiving allMessages PROPS\n    // if(!localStorage.chatID.length){\n    //   this.setState({\n    //     chatID: this.props.allMessages[0].chat_id,\n    //     otherID: this.props.allMessages[0].id,\n    //   });\n    //   this.props.loadChat(ID, this.props.allMessages[0].chat_id, this.props.allMessages[0].id);\n    // }\n  }\n  openSocket () {\n    let socketURL = `${wssURL}/?token=${localStorage.getItem('access-token')}&client=${localStorage.getItem('client')}&uid=${localStorage.getItem('uid')}`;\n    let ws = new WebSocket(socketURL);\n\n    let subscribe_params = JSON.stringify({\n      command: 'subscribe',\n      identifier: JSON.stringify({\n        chat_id: this.props.canon,\n        channel: 'MessagesChannel'\n      })\n    });\n\n    ws.onopen = function(e) {\n      console.log(e, 'onopen ------');\n      // SUBSCRIBE\n      ws.send(subscribe_params);\n    };\n\n    ws.onmessage = function (evt) {\n      var receivedData = JSON.parse(evt.data || '{}');\n      var dataIdentity = JSON.parse(receivedData.identifier || '{}');\n      var messageData = receivedData.message;\n      if (\n        receivedData.identifier &&\n        dataIdentity.channel === 'MessagesChannel' &&\n        dataIdentity.chat_id === this.state.chatID &&\n        messageData\n      ) {\n        var incomingMessage = receivedData.message;\n        if (incomingMessage.event_type && incomingMessage.event_type.match(/rtm/)) {\n          if (parseInt(this.state.otherID) === parseInt(incomingMessage.typing_user_id)) {\n\n            if (incomingMessage.event_sub_type === 'start_chat_typing') {\n              this.setState({\n                userTyping: true,\n                userNameTyping: incomingMessage.message\n              });\n            }\n            if (incomingMessage.event_sub_type === 'end_chat_typing') {\n              this.setState({\n                userTyping: false,\n                userNameTyping: ''\n              });\n            }\n          }\n        }\n        if (incomingMessage.from_username && incomingMessage.from_username !== localStorage.username) {\n          this.setState({\n            chatHistory : [ ...this.state.chatHistory, incomingMessage],\n            userTyping: false,\n            userNameTyping: ''\n          });\n        }\n      }\n    }.bind(this);\n\n    ws.onclose = function(e) {\n      console.log(e, \"Connection is closed...\");\n    };\n  }\n  componentWillUnmount() {\n    ws.close();\n    localStorage.removeItem(\"chatID\");\n  }\n\n  clearHistory () {\n    this.setState({\n      chatHistory: []\n    });\n  }\n  componentDidUpdate(prevProps, prevState) {\n    // This loads the most recent messages upon receiving allMessages PROPS\n    if (prevProps.messages !== this.props.messages) {\n      this.clearHistory();\n      this.openSocket();\n    }\n  }\n\n  sendHandler(evt) {\n    evt.preventDefault();\n    const messageObject = {\n      from_username: localStorage.name,\n      message: this.state.chatInput,\n      from_user_avatar_thumb: localStorage.image\n    };\n\n    console.log(localStorage.chatID);\n    this.props.sendFirstMessage(messageObject.message, localStorage.chatID);\n\n    messageObject.fromMe = true;\n\n    this.addMessage(messageObject);\n    this.setState({\n      chatInput: ''\n    });\n  }\n\n  handleChatInput(evt) {\n    this.setState({\n      chatInput: evt.target.value\n    });\n  }\n\n  render() {\n    return (\n        <React.Fragment>\n          <div className=\"Messages-ChatInput\">\n            <form className=\"chat-input\" onSubmit={this.sendHandler}>\n              <input type=\"text\"\n                onChange={this.handleChatInput}\n                value={this.state.chatInput}\n                placeholder=\"Write a Message...\"\n                autoFocus={true}\n                />\n            </form>\n          </div>\n          <div className=\"myMessages\">\n          { this.state.chatHistory.length ? (\n            <React.Fragment>\n                { this.state.chatHistory.map((chats) => {\n                  return (\n                    <div className=\"DirectMessages\">\n                      <Message messages={ chats } />\n                  </div>\n                  )\n                })}\n            </React.Fragment>\n          ) : null }\n          </div>\n\n       <div className=\"NewMessageHeader\">\n         Send your first message\n       </div>\n\n\n        </React.Fragment>\n\n    );\n  }\n}\n\nconst mapStateToProps = (state) => {\n  return {\n    user : state.userList,\n    chatID : state.chatID,\n    messages : state.chatList,\n    allMessages : state.allChatsList\n  }\n}\n\nconst mapDispatchToProps = (dispatch) => {\n  return {\n    getUser: (ID) => {\n      dispatch(getUser(ID))\n    },\n    sendFirstMessage: (message, id) => {\n      dispatch(sendFirstMessage(message, id));\n    },\n    loadChat: (myID, chatID, otherID) => {\n      dispatch(loadChat(myID, chatID, otherID));\n    },\n    createChatID: (myID, otherID) => {\n      dispatch(createChatID(myID, otherID))\n    },\n    getAllChats: (id) => {\n      dispatch(getAllChats(id))\n    },\n  }\n}\n\nexport default connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(NewMessageChatBox);\n\n\n\n           // <div>\n           // { this.state.chatHistory.length ? (\n           //     <React.Fragment>\n           //         { this.state.chatHistory.map((chats) => {\n           //           return (\n           //             <div>\n           //               <Message messages={chats} />\n           //           </div>\n           //           )\n           //         })}\n           //     </React.Fragment>\n           //   ) : null }\n           // </div>\n           // </div>"]},"metadata":{},"sourceType":"module"}